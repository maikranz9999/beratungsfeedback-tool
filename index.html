<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Beratungsfeedback</title>
  <style>
    :root { 
      --bg: #fefefe; 
      --muted: #666; 
      --line: #ccc; 
      --card: #f4f4f4; 
      --accent: #222; 
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
    }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; 
      max-width: 900px; 
      margin: 40px auto; 
      padding: 20px; 
      background: var(--bg);
      line-height: 1.6;
    }
    
    h1 { 
      margin-top: 0; 
      color: var(--accent);
      text-align: center;
    }
    
    .tabs { 
      display: flex; 
      gap: 10px; 
      margin-bottom: 20px; 
      flex-wrap: wrap; 
    }
    
    .tab-button { 
      padding: 10px 16px; 
      border: 1px solid var(--line); 
      background: #eee; 
      cursor: pointer; 
      border-radius: 8px;
      transition: all 0.2s ease;
      font-weight: 500;
    }
    
    .tab-button:hover {
      background: #ddd;
    }
    
    .tab-button.active { 
      background: var(--accent); 
      color: white;
      border-color: var(--accent);
    }
    
    .tab-content { 
      display: none; 
    }
    
    .tab-content.active { 
      display: block; 
    }
    
    .settings {
      margin-bottom: 20px;
      padding: 15px;
      background: var(--card);
      border-radius: 8px;
      border: 1px solid var(--line);
    }
    
    .checkbox-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .checkbox-wrapper input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }
    
    label { 
      font-weight: bold; 
      display: block; 
      margin: 18px 0 8px;
      color: var(--accent);
    }
    
    textarea { 
      width: 100%; 
      height: 140px; 
      padding: 12px; 
      font-size: 14px; 
      border-radius: 8px; 
      border: 2px solid var(--line); 
      resize: vertical;
      font-family: inherit;
      transition: border-color 0.2s ease;
      box-sizing: border-box;
    }
    
    textarea:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    .word-count { 
      font-size: 12px; 
      color: var(--muted); 
      margin-top: 4px;
      text-align: right;
    }
    
    .feedback { 
      background: var(--card); 
      padding: 15px; 
      margin-top: 10px; 
      border-radius: 8px; 
      border-left: 4px solid #999; 
      white-space: pre-wrap; 
      min-height: 50px;
      font-size: 14px;
      line-height: 1.5;
    }
    
    .feedback.success {
      border-left-color: var(--success);
      background: #d4edda;
    }
    
    .feedback.error {
      border-left-color: var(--danger);
      background: #f8d7da;
    }

    .feedback-container {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .requirement-box {
      border-radius: 8px;
      padding: 15px;
      border-left: 5px solid;
    }
    
    .requirement-box.green {
      background: #d4edda;
      border-left-color: #28a745;
      color: #155724;
    }
    
    .requirement-box.yellow {
      background: #fff3cd;
      border-left-color: #ffc107;
      color: #856404;
    }
    
    .requirement-box.red {
      background: #f8d7da;
      border-left-color: #dc3545;
      color: #721c24;
    }
    
    .requirement-title {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .requirement-content {
      margin-bottom: 10px;
      line-height: 1.5;
    }
    
    .quote {
      background: rgba(0,0,0,0.05);
      padding: 8px 12px;
      border-radius: 4px;
      font-style: italic;
      margin: 8px 0;
      border-left: 3px solid rgba(0,0,0,0.2);
    }
    
    .improvement {
      background: rgba(0,0,0,0.03);
      padding: 10px;
      border-radius: 4px;
      margin-top: 8px;
    }
    
    .improvement-title {
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    button { 
      padding: 12px 24px; 
      margin-top: 20px; 
      font-size: 16px; 
      background: var(--accent); 
      color: #fff; 
      border: none; 
      border-radius: 8px; 
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
      min-width: 200px;
    }
    
    button:hover:not(:disabled) {
      background: #333;
      transform: translateY(-1px);
    }
    
    button:disabled { 
      opacity: 0.7; 
      cursor: not-allowed;
      transform: none;
    }
    
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #ffffff40;
      border-top: 2px solid #ffffff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .status-message {
      margin-top: 10px;
      padding: 10px;
      border-radius: 6px;
      font-size: 14px;
      display: none;
    }
    
    .status-message.show {
      display: block;
    }
    
    .status-message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status-message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    @media (max-width: 768px) {
      body {
        margin: 20px auto;
        padding: 15px;
      }
      
      .tabs {
        flex-direction: column;
      }
      
      .tab-button {
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <h1>🎯 Beratungsfeedback</h1>
  
  <div class="settings">
    <div class="checkbox-wrapper">
      <input type="checkbox" id="onlyFrame" />
      <label for="onlyFrame" style="margin: 0; font-weight: normal;">Nur Experten-Frame bewerten</label>
    </div>
  </div>

  <div class="tabs">
    <div class="tab-button active" onclick="switchTab('frame')">🧠 Experten-Frame</div>
    <div class="tab-button" onclick="switchTab('methode')">🛠 Methode</div>
    <div class="tab-button" onclick="switchTab('beratung')">💬 Beratung</div>
  </div>

  <div id="frameTab" class="tab-content active">
    <label for="frame">🧠 Experten-Frame</label>
    <textarea 
      id="frame" 
      placeholder="Was macht dich zur Expert:in? Erzähle 1-3 detaillierte Stories aus deiner beruflichen Erfahrung..." 
      oninput="updateWordCount('frame')"
    ></textarea>
    <div class="word-count" id="frameWordCount">Wörter: 0 (optimal: 500-800)</div>
    <div id="frameFeedback" class="feedback"></div>
  </div>

  <div id="methodeTab" class="tab-content">
    <label for="methode">🛠 Methode</label>
    <textarea 
      id="methode" 
      placeholder="Welche Methode hast du erklärt? Beschreibe dein spezifisches Vorgehen..."
    ></textarea>
    <div id="methodeFeedback" class="feedback"></div>
  </div>

  <div id="beratungTab" class="tab-content">
    <label for="beratung">💬 Beratung</label>
    <textarea 
      id="beratung" 
      placeholder="Was wurde dem Kunden empfohlen? Welche konkreten Schritte wurden vorgeschlagen..."
    ></textarea>
    <div id="beratungFeedback" class="feedback"></div>
  </div>

  <button id="submitBtn">
    <span id="buttonText">Feedback generieren</span>
  </button>

  <div id="statusMessage" class="status-message"></div>

  <script>
    function switchTab(tab) {
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.querySelector('.tab-button[onclick="switchTab(\'' + tab + '\')"]').classList.add('active');
      document.getElementById(tab + 'Tab').classList.add('active');
    }

    function updateWordCount(id) {
      const text = document.getElementById(id).value || '';
      const words = text.trim().split(/\s+/).filter(Boolean);
      const count = words.length;
      
      let status = '';
      if (id === 'frame') {
        if (count < 500) status = ' (zu kurz)';
        else if (count > 800) status = ' (zu lang)';
        else status = ' (optimal)';
      }
      
      document.getElementById(id + 'WordCount').innerText = 'Wörter: ' + count + status;
    }

    function showStatus(message, type) {
      type = type || 'success';
      const statusEl = document.getElementById('statusMessage');
      statusEl.textContent = message;
      statusEl.className = 'status-message show ' + type;
      
      setTimeout(function() {
        statusEl.classList.remove('show');
      }, 5000);
    }

    function formatStructuredFeedbackFromObject(feedbackObj) {
      const requirements = [
        { key: '1_laenge', title: 'Länge: 500-800 Wörter' },
        { key: '2_storytelling', title: 'Storytelling statt oberflächlicher Aufzählung' },
        { key: '3_keine_chronologie', title: 'Keine chronologische Erzählung des Werdegangs' },
        { key: '4_expertise_begruendung', title: 'Begründung der Expertise mit Experten-Merkmalen' },
        { key: '5_gespraechston', title: 'Natürlicher Gesprächston (gesprochenes Wort)' },
        { key: '6_negative_erfahrungen', title: 'Integration negativer Erfahrungen/Learnings' },
        { key: '7_professionelle_tonalitaet', title: 'Professionelle Tonalität ohne Romantisierung' },
        { key: '8_keine_ueberfluss', title: 'Keine überflüssigen Frames oder Ankündigungen' }
      ];

      let html = '<div class="feedback-container">';

      requirements.forEach(function(req, index) {
        const feedback = feedbackObj[req.key];
        if (feedback) {
          const status = feedback.status === 'ERFÜLLT' ? 'green' : 
                        feedback.status === 'TEILWEISE' ? 'yellow' : 'red';
          
          const statusIcon = status === 'green' ? '✅' : status === 'yellow' ? '⚠️' : '❌';
          
          html += '<div class="requirement-box ' + status + '">';
          html += '<div class="requirement-title">' + statusIcon + ' ' + (index + 1) + '. ' + req.title + '</div>';
          html += '<div class="requirement-content">';
          html += '<strong>STATUS:</strong> ' + feedback.status + '<br>';
          html += '<strong>BEGRÜNDUNG:</strong> ' + feedback.begruendung + '<br>';
          
          if (feedback.zitate && feedback.zitate.length > 0) {
            html += '<strong>ZITATE:</strong><br>';
            feedback.zitate.forEach(function(zitat) {
              html += '<div class="quote">"' + zitat + '"</div>';
            });
          }
          
          if (feedback.verbesserung && feedback.verbesserung.trim() !== '') {
            html += '<div class="improvement">';
            html += '<div class="improvement-title">VERBESSERUNG:</div>';
            html += feedback.verbesserung;
            html += '</div>';
          }
          
          html += '</div></div>';
        }
      });

      html += '</div>';
      return html;
    }

    function formatStructuredFeedbackFromString(text) {
      const requirements = [
        'Länge: 500-800 Wörter',
        'Storytelling statt oberflächlicher Aufzählung', 
        'Keine chronologische Erzählung des Werdegangs',
        'Begründung der Expertise mit Experten-Merkmalen',
        'Natürlicher Gesprächston (gesprochenes Wort)',
        'Integration negativer Erfahrungen/Learnings',
        'Professionelle Tonalität ohne Romantisierung',
        'Keine überflüssigen Frames oder Ankündigungen'
      ];

      let html = '<div class="feedback-container">';
      const sections = text.split(/\d+\.\s+/).filter(Boolean);
      
      sections.forEach(function(section, index) {
        if (index < requirements.length) {
          const status = section.includes('ERFÜLLT') && !section.includes('NICHT_ERFÜLLT') ? 'green' : 
                       section.includes('TEILWEISE') ? 'yellow' : 'red';
          
          const statusIcon = status === 'green' ? '✅' : status === 'yellow' ? '⚠️' : '❌';
          
          html += '<div class="requirement-box ' + status + '">';
          html += '<div class="requirement-title">' + statusIcon + ' ' + (index + 1) + '. ' + requirements[index] + '</div>';
          html += '<div class="requirement-content">' + section.replace(/STATUS:|BEGRÜNDUNG:|ZITATE:|VERBESSERUNG:/g, '<strong>$&</strong>') + '</div>';
          html += '</div>';
        }
      });
      
      html += '</div>';
      return html;
    }

    function formatStructuredFeedback(feedbackObj) {
      if (typeof feedbackObj === 'string') {
        return formatStructuredFeedbackFromString(feedbackObj);
      }
      
      if (typeof feedbackObj === 'object' && feedbackObj !== null) {
        return formatStructuredFeedbackFromObject(feedbackObj);
      }
      
      return '<div>Unbekanntes Feedback-Format: ' + JSON.stringify(feedbackObj) + '</div>';
    }

    function setFeedback(id, text, isError) {
      const element = document.getElementById(id);
      isError = isError || false;
      
      console.log('setFeedback called with:', { id: id, textType: typeof text, text: text });
      
      if (!text) {
        element.textContent = 'Kein Feedback erhalten.';
        element.className = 'feedback';
        return;
      }
      
      if (typeof text === 'object') {
        element.innerHTML = formatStructuredFeedback(text);
        element.className = 'feedback';
        return;
      }
      
      const textStr = String(text);
      
      if (textStr.includes('1. Länge:')) {
        element.innerHTML = formatStructuredFeedback(textStr);
        element.className = 'feedback';
      } else if (textStr.includes('<div class="feedback-container">')) {
        element.innerHTML = textStr;
        element.className = 'feedback';
      } else {
        element.textContent = textStr || 'Kein Feedback erhalten.';
        element.className = 'feedback' + (isError ? ' error' : '');
      }
    }

    function getFeedback() {
      const btn = document.getElementById('submitBtn');
      const buttonText = document.getElementById('buttonText');
      const originalText = buttonText.textContent;
      
      const frameText = document.getElementById('frame').value.trim();
      if (!frameText) {
        showStatus('Bitte geben Sie einen Experten-Frame ein.', 'error');
        return;
      }

      btn.disabled = true;
      buttonText.innerHTML = '<span class="loading"></span>Wird bewertet...';
      
      setFeedback('frameFeedback', '');
      setFeedback('methodeFeedback', '');
      setFeedback('beratungFeedback', '');

      const payload = {
        frame: frameText,
        methode: document.getElementById('methode').value,
        beratung: document.getElementById('beratung').value,
        onlyFrame: document.getElementById('onlyFrame').checked
      };

      fetch('/api/feedback', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      .then(function(response) {
        return response.text().then(function(rawText) {
          console.log('Response status:', response.status);
          console.log('Response text:', rawText);

          let result;
          try {
            result = JSON.parse(rawText);
          } catch (parseError) {
            console.error('JSON Parse Error:', parseError);
            console.error('Raw response:', rawText);
            setFeedback('frameFeedback', 'JSON Parse Fehler:\n\nRoh-Antwort:\n' + rawText.substring(0, 1000), true);
            return;
          }

          if (!response.ok) {
            const errorMsg = result.frameFeedback || result.error || ('Server-Fehler ' + response.status);
            setFeedback('frameFeedback', errorMsg, true);
            showStatus('Fehler beim Generieren des Feedbacks', 'error');
            return;
          }

          setFeedback('frameFeedback', result.frameFeedback || 'Keine Rückmeldung erhalten.');
          if (!payload.onlyFrame) {
            setFeedback('methodeFeedback', result.methodeFeedback || '');
            setFeedback('beratungFeedback', result.beratungFeedback || '');
          }
          
          showStatus('Feedback erfolgreich generiert!', 'success');
        });
      })
      .catch(function(error) {
        console.error('Fetch error:', error);
        setFeedback('frameFeedback', 'Netzwerkfehler: ' + error.message, true);
        showStatus('Verbindungsfehler. Bitte versuchen Sie es erneut.', 'error');
      })
      .finally(function() {
        btn.disabled = false;
        buttonText.textContent = originalText;
      });
    }

    document.addEventListener('DOMContentLoaded', function() {
      updateWordCount('frame');
      document.getElementById('submitBtn').addEventListener('click', getFeedback);
    });
  </script>
</body>
</html>
