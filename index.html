<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Beratungsfeedback</title>
  <style>
    :root { --bg:#fefefe; --muted:#666; --line:#ccc; --card:#f4f4f4; --accent:#222; }
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 40px auto; padding: 20px; background: var(--bg); }
    h1 { margin-top: 0; }
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .tab-button { padding: 8px 16px; border: 1px solid var(--line); background: #eee; cursor: pointer; border-radius: 6px; }
    .tab-button.active { background: #ddd; font-weight: bold; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    label { font-weight: bold; display: block; margin: 18px 0 8px; }
    textarea { width: 100%; height: 140px; padding: 10px; font-size: 14px; border-radius: 6px; border: 1px solid var(--line); resize: vertical; }
    .word-count { font-size: 12px; color: var(--muted); margin-top: 4px; }
    .feedback { background: var(--card); padding: 12px; margin-top: 8px; border-radius: 8px; border-left: 4px solid #999; white-space: pre-wrap; min-height: 42px; }
    button { padding: 10px 16px; margin-top: 20px; font-size: 16px; background: var(--accent); color: #fff; border: none; border-radius: 6px; cursor: pointer; }
    button[disabled] { opacity: .7; cursor: progress; }
  </style>
</head>
<body>
  <h1>Beratungsfeedback</h1>
  <div class="tabs">
    <div class="tab-button active" onclick="switchTab('frame')">ðŸ§  Experten-Frame</div>
    <div class="tab-button" onclick="switchTab('methode')">ðŸ›  Methode</div>
    <div class="tab-button" onclick="switchTab('beratung')">ðŸ’¬ Beratung</div>
  </div>

  <label><input type="checkbox" id="onlyFrame" /> Nur Experten-Frame bewerten</label>

  <div id="frameTab" class="tab-content active">
    <label for="frame">ðŸ§  Experten-Frame</label>
    <textarea id="frame" placeholder="Was macht dich zur Expert:in?" oninput="updateWordCount('frame')"></textarea>
    <div class="word-count" id="frameWordCount">WÃ¶rter: 0</div>
    <div id="frameFeedback" class="feedback"></div>
  </div>

  <div id="methodeTab" class="tab-content">
    <label for="methode">ðŸ›  Methode</label>
    <textarea id="methode" placeholder="Welche Methode hast du erklÃ¤rt?"></textarea>
    <div id="methodeFeedback" class="feedback"></div>
  </div>

  <div id="beratungTab" class="tab-content">
    <label for="beratung">ðŸ’¬ Beratung</label>
    <textarea id="beratung" placeholder="Was wurde dem Kunden empfohlen?"></textarea>
    <div id="beratungFeedback" class="feedback"></div>
  </div>

  <button id="submitBtn" onclick="getFeedback()">Feedback generieren</button>

  <script>
    function switchTab(tab) {
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.querySelector(`.tab-button[onclick="switchTab('${tab}')"]`).classList.add('active');
      document.getElementById(tab + 'Tab').classList.add('active');
    }

    function updateWordCount(id) {
      const words = (document.getElementById(id).value || '').trim().split(/\s+/).filter(Boolean);
      document.getElementById(id + 'WordCount').innerText = `WÃ¶rter: ${words.length}`;
    }

    async function getFeedback() {
      const btn = document.getElementById('submitBtn');
      btn.disabled = true; btn.textContent = 'Wird bewertetâ€¦';

      const payload = {
        frame: document.getElementById('frame').value,
        methode: document.getElementById('methode').value,
        beratung: document.getElementById('beratung').value,
        onlyFrame: document.getElementById('onlyFrame').checked
      };

      const setFeedback = (id, text) => document.getElementById(id).innerText = text || '';
      setFeedback('frameFeedback', '');
      setFeedback('methodeFeedback', '');
      setFeedback('beratungFeedback', '');

      try {
        const resp = await fetch('/api/feedback', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const raw = await resp.text();
        console.log('HTTP', resp.status, resp.statusText);
        console.log('RAW', raw);

        if (!resp.ok) {
          setFeedback('frameFeedback', `Serverfehler ${resp.status}: ${raw}`);
          return;
        }

        let result;
        try {
          result = JSON.parse(raw);
        } catch (err) {
          setFeedback('frameFeedback', 'Antwort war kein gÃ¼ltiges JSON.');
          return;
        }

        setFeedback('frameFeedback', result.frameFeedback || 'Keine RÃ¼ckmeldung.');
        setFeedback('methodeFeedback', result.methodeFeedback || '');
        setFeedback('beratungFeedback', result.beratungFeedback || '');
      } catch (err) {
        console.error('Fetch error:', err);
        setFeedback('frameFeedback', 'Netzwerkfehler: ' + (err.message || err));
      } finally {
        btn.disabled = false; btn.textContent = 'Feedback generieren';
      }
    }
  </script>
</body>
</html>
